<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compliance Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <header class="mb-8 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Compliance Audit Assistant
          </h1>
          <p class="text-gray-600 mt-2">
            Upload a questionnaire to extract requirements and evaluate
            compliance.
          </p>
        </div>
        <div
          id="health-status"
          class="text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-700 animate-pulse"
        >
          Connecting...
        </div>
      </header>

      <!-- Upload Section -->
      <div
        class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8"
      >
        <div class="flex items-end gap-4">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Upload Audit PDF</label
            >
            <input
              type="file"
              id="pdf-upload"
              accept=".pdf"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
          </div>
          <button
            onclick="uploadAndExtract()"
            id="extract-btn"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Process PDF
          </button>
        </div>
      </div>

      <div
        class="fixed top-4 right-4 bg-white p-4 rounded-xl shadow-lg border border-gray-200 hidden"
        id="stats-box"
      >
        <h3 class="font-bold text-gray-700 mb-2">Results</h3>
        <div class="flex gap-4 text-sm">
          <div class="text-green-600 font-semibold">
            Yes: <span id="count-yes">0</span>
          </div>
          <div class="text-red-600 font-semibold">
            No: <span id="count-no">0</span>
          </div>
          <div class="text-yellow-600 font-semibold">
            Uncertain: <span id="count-uncertain">0</span>
          </div>
        </div>
        <div class="mt-2 text-xs text-gray-500">
          Processed: <span id="count-processed">0</span>/<span id="count-total"
            >0</span
          >
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-area" class="hidden space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800">
            Extracted Requirements
          </h2>
          <button
            onclick="evaluateAllParallel()"
            id="eval-btn"
            class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors shadow-sm flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Run Compliance Check
          </button>
        </div>

        <div
          class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16"
                >
                  #
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4"
                >
                  Requirement
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Evidence
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="results-body">
              <!-- Rows injected here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div
        id="loader"
        class="hidden fixed inset-0 bg-gray-900/50 flex items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
          <div
            class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-4"
          ></div>
          <p class="text-gray-700 font-medium" id="loader-text">
            Processing...
          </p>
        </div>
      </div>
    </div>

    <script>
      let extractedQuestions = [];
      let counts = { yes: 0, no: 0, uncertain: 0, processed: 0 };

      // Check Health on Load
      fetch("/health")
        .then((res) => res.json())
        .then((data) => {
          const el = document.getElementById("health-status");
          if (data.policies_indexed) {
            el.textContent = `Online: ${data.policies_indexed} policies indexed`;
            el.className =
              "text-sm px-3 py-1 rounded-full bg-green-100 text-green-800";
          } else {
            el.textContent = `Online: ${data.pages_indexed || 0} pages indexed`;
            el.className =
              "text-sm px-3 py-1 rounded-full bg-green-100 text-green-800";
          }
        })
        .catch(() => {
          const el = document.getElementById("health-status");
          el.textContent = "Offline / Connection Error";
          el.className =
            "text-sm px-3 py-1 rounded-full bg-red-100 text-red-800";
        });

      async function uploadAndExtract() {
        const fileInput = document.getElementById("pdf-upload");
        if (!fileInput.files[0]) return alert("Please select a file first.");

        setLoading(true, "Extracting questions from PDF...");

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
          const res = await fetch("/upload_questionnaire", {
            method: "POST",
            body: formData,
          });
          if (!res.ok) throw new Error("Failed to upload");

          extractedQuestions = await res.json();
          renderTable(extractedQuestions);
          resetCounts(extractedQuestions.length);
          document.getElementById("results-area").classList.remove("hidden");
          document.getElementById("stats-box").classList.remove("hidden");
        } catch (err) {
          alert("Error: " + err.message);
        } finally {
          setLoading(false);
        }
      }

      async function evaluateAllParallel() {
        setLoading(false); // No global overlay, individual spinners
        document.getElementById("eval-btn").disabled = true;
        document.getElementById("eval-btn").classList.add("opacity-50");

        // Fire requests in parallel (browser handles concurrency)
        extractedQuestions.forEach((q, index) => {
          processSingleQuestion(q, index);
        });
      }

      async function processSingleQuestion(question, index) {
        const row = document.getElementById(`row-${index}`);
        updateRowStatus(
          index,
          "Processing...",
          "bg-blue-100 text-blue-800",
          true,
        );

        try {
          const res = await fetch("/process_question", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(question),
          });
          const result = await res.json();
          renderResult(result, index);
          updateStats(result.met);
        } catch (err) {
          console.error(err);
          updateRowStatus(index, "Error", "bg-red-100 text-red-800");
        }
      }

      function updateRowStatus(index, text, classes, loading = false) {
        const row = document.getElementById(`row-${index}`);
        if (!row) return;
        const statusCell = row.children[2];
        let content = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${classes}">${text}</span>`;
        if (loading) {
          content += `<svg class="animate-spin ml-2 h-4 w-4 text-blue-600 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        }
        statusCell.innerHTML = content;
      }

      function renderResult(res, index) {
        const row = document.getElementById(`row-${index}`);
        if (!row) return;

        // Status Badge
        let badgeClass = "bg-gray-100 text-gray-800";
        const metLower = res.met.toLowerCase();

        if (metLower === "yes") badgeClass = "bg-green-100 text-green-800";
        else if (metLower === "no") badgeClass = "bg-red-100 text-red-800";
        else if (metLower === "uncertain")
          badgeClass = "bg-yellow-100 text-yellow-800";

        row.children[2].innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClass}">${res.met.toUpperCase()}</span>`;

        // Evidence & Reasoning Columns
        let html = "";

        // 1. Sources Header: Loop through all sources
        if (res.evidence.sources && res.evidence.sources.length > 0) {
          html += `<div class="mb-3 space-y-2">`;
          res.evidence.sources.forEach((source) => {
            const docName = source.doc.split(" - ")[0] || source.doc;
            const title =
              source.doc_title ||
              source.doc.split(" - ")[1] ||
              "Policy Document";
            const pageStr =
              source.page && source.page !== "N/A"
                ? ` (Page ${source.page}/${source.total_pages || "?"})`
                : "";

            html += `
                        <div>
                            <span class="text-sm font-bold text-gray-900 leading-tight">${docName}</span>
                            <span class="font-normal text-sm text-gray-600">${pageStr}</span>
                            <div class="text-xs italic text-gray-600 leading-tight">${title}</div> 
                        </div>
                     `;
          });
          html += `</div>`;
        } else if (res.evidence.doc) {
          // Backward compatibility or fallback
          const docName = res.evidence.doc.split(" - ")[0] || res.evidence.doc;
          const title = res.evidence.doc_title_only || "Policy Document";
          const pageStr = res.evidence.page
            ? ` (Page ${res.evidence.page}/${res.evidence.total_pages || "?"})`
            : "";
          html += `
                    <div class="mb-3">
                        <div class="text-sm font-bold text-gray-900 leading-tight">${docName} <span class="font-normal text-gray-600">${pageStr}</span></div>
                        <div class="text-xs text-gray-600 mt-1 leading-tight">${title}</div> 
                    </div>
                 `;
        }

        // 2. Evidence Excerpt (Code Block)
        if (res.evidence.excerpt) {
          const isNegative = metLower === "no" || metLower === "uncertain";
          const borderColor = isNegative
            ? "border-l-red-400 bg-red-50"
            : "border-l-yellow-400 bg-yellow-50";

          // Unitalicized content
          html += `
                    <div class="${borderColor} p-3 rounded border border-gray-200 text-xs text-gray-800 font-mono border-l-4 mb-2 not-italic">
                        "${res.evidence.excerpt}"
                    </div>
                `;
        } else if (metLower === "no") {
          html += `<div class="bg-red-50 p-2 rounded border border-red-200 text-xs text-red-800 font-mono border-l-4 border-l-red-400 mb-2 not-italic">Evidence not found in document.</div>`;
        }

        // 3. Reasoning (Plain text)
        if (
          res.evidence.reason &&
          res.evidence.reason !== res.evidence.excerpt
        ) {
          html += `<div class="text-sm text-gray-700 not-italic">${res.evidence.reason}</div>`;
        }

        row.children[3].innerHTML = html;
      }

      function resetCounts(total) {
        counts = { yes: 0, no: 0, uncertain: 0, processed: 0 };
        document.getElementById("count-total").textContent = total;
        updateStatsDisplay();
      }

      function updateStats(status) {
        const s = status.toLowerCase();
        if (s === "yes") counts.yes++;
        else if (s === "no") counts.no++;
        else counts.uncertain++;

        counts.processed++;
        updateStatsDisplay();
      }

      function updateStatsDisplay() {
        document.getElementById("count-yes").textContent = counts.yes;
        document.getElementById("count-no").textContent = counts.no;
        document.getElementById("count-uncertain").textContent =
          counts.uncertain;
        document.getElementById("count-processed").textContent =
          counts.processed;
      }

      function renderTable(questions) {
        const tbody = document.getElementById("results-body");
        tbody.innerHTML = questions
          .map(
            (q, i) => `
                <tr id="row-${i}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${i + 1}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <div class="font-medium text-gray-700 mb-1">${q.section || ""}</div>
                        ${q.question}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            Pending
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 italic">
                        Waiting...
                    </td>
                </tr>
            `,
          )
          .join("");
      }

      function setLoading(isActive, text) {
        const loader = document.getElementById("loader");
        const txt = document.getElementById("loader-text");
        if (isActive) {
          txt.textContent = text;
          loader.classList.remove("hidden");
        } else {
          loader.classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
